<!-- A quick and dirty POC for connecting a visualization to a Spark-based data reduction service. -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Test Page</title>
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.14/require.js"></script>

    <script>
      requirejs.config({
        paths: {
          d3: "http://d3js.org/d3.v3.min",
          model: "http://curran.github.io/model/dist/model",
          lodash: "https://rawgit.com/lodash/lodash/3.0.1/lodash.min"
        }
      });
    </script>

    <style>
        /* Make bars black. */
        .bar {
          fill: black;
        }
        /* Style the axis tick mark text. */
        .axis .tick text {
          /* TODO move this into inline CSS defined by a Model property xAxisTickTextSize. */
          font: 12pt sans-serif;
        }
        /* Style the axis label text. */
        .axis text {
          /* TODO move this into inline CSS defined by a Model property xAxisTextSize. */
          font: 16pt sans-serif;
        }
        /* Style the lines of the axes. */
        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }
        /* Hide the line of the X axis. */
        .x.axis path {
          display: none;
        }
        /* Make the visualization container fill the page. */
        #container {
          position: fixed;
          left: 0px;
          right: 0px;
          top: 20px;
          bottom: 0px;
        }
    </style>
  </head>
  <body>

    <!-- The dropdown for selecting columns. -->
    <select id="nominalColumns">
        <option value="workclass">Workclass</option>
        <option value="education">Education</option>
        <option value="marital-status">Marital Status</option>
        <option value="occupation">Occupation</option>
        <option value="relationship">Relationship</option>
        <option value="race">Race </option>
        <option value="sex" selected="selected">Sex</option>
        <option value="native-country">Native Country</option>
        <option value="income-category">Income Category</option>
    </select>

    <!-- The bar chart will be inserted here. -->
    <div id="container"></div>

    <script>

    require(["barChart"], function (BarChart) {

        // The default data set to use in this test example.
        var dataset = "hdfs://localhost:9000/data/adult";

        var container = $("#container")[0];
        var barChart = BarChart(container);

        // Set axis properties.
        barChart.set({
            yAttribute: "count",
            yAxisLabel: "Count",
            yAxisTickFormat: "",
            margin: {
              top: 20,
              right: 20,
              bottom: 50,
              left: 100
            }
        });

        // Invokes the Rails REST API that in turn invokes spark-jobserver.
        function reduceData(dataset, dimension, callback){
            var options = {
                dataset: dataset,
                cube: {
                    dimensions: [
                        { name: dimension }
                    ],
                    measures: [
                        { aggregationOp: "count" }
                    ]
                }
            };

            // Invoke the API for computing data cubes with Spark.
            $.ajax({
                type: "GET",
                url: "/vis_engine/reduce_data",
                data: {
                    options: JSON.stringify(options)
                },
                success: function(data){
                    callback(JSON.parse(data).result);
                }
            });
        }

        $("#nominalColumns").change(function (a){
            var selectedOption = $("#nominalColumns option:selected")[0];
            var selectedColumn = selectedOption.value;
            var selectedColumnLabel = selectedOption.text;

            reduceData(dataset, selectedColumn, function(data){
                data = _.sortBy(data, "count").reverse();
                barChart.data = data;
                barChart.xAttribute = selectedColumn;
                barChart.xAxisLabel = selectedColumnLabel;
            });
        }).change();

        // Set the bar chart size
        // based on the size of its container,
        function computeBox(){
            barChart.box = {
                width: container.clientWidth,
                height: container.clientHeight
            };
            console.log(barChart.box);
        }

        // once to initialize `model.box`, and
        computeBox();

        // whenever the browser window resizes in the future.
        window.addEventListener("resize", computeBox);
    });
    </script>
  </body>
</html>
